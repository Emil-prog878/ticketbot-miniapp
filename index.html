<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>TicketBot</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Unbounded:wght@400;600;800&family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#080812;--bg2:#10101f;--bg3:#18182e;--bg4:#22223a;
  --accent:#7c3aed;--a2:#a855f7;--gold:#f59e0b;
  --green:#10b981;--red:#ef4444;--txt:#f0f0ff;--muted:#6b6b9a;--bdr:#2a2a4a;
  --tab-h:68px;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow:hidden}
body{font-family:'Manrope',sans-serif;background:var(--bg);color:var(--txt);font-size:14px}

@keyframes fadeUp{from{opacity:0;transform:translateY(18px)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes pop{0%{transform:scale(0)}70%{transform:scale(1.15)}100%{transform:scale(1)}}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
@keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-7px)}}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
@keyframes rpl{to{transform:scale(4);opacity:0}}
@keyframes glow{0%,100%{box-shadow:0 0 15px rgba(124,58,237,.3)}50%{box-shadow:0 0 40px rgba(124,58,237,.65)}}
@keyframes tabPop{0%{transform:translateY(0) scale(1)}40%{transform:translateY(-5px) scale(1.12)}100%{transform:translateY(0) scale(1)}}
@keyframes dotIn{from{transform:scale(0);opacity:0}to{transform:scale(1);opacity:1}}
@keyframes slideUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}

/* ‚îÄ‚îÄ –°–¢–†–ê–ù–ò–¶–´ ‚îÄ‚îÄ */
.page{position:fixed;inset:0;display:flex;flex-direction:column;background:var(--bg);z-index:10;transition:opacity .22s ease,transform .22s ease}
.page.hide{opacity:0;pointer-events:none;transform:translateX(18px)}
#pgDetail{z-index:20}
#pgOnboard{align-items:center;justify-content:center;padding:32px 22px;text-align:center;
  background:radial-gradient(ellipse at 50% -5%,rgba(124,58,237,.25) 0%,transparent 65%),var(--bg)}

/* ‚îÄ‚îÄ –ù–ò–ñ–ù–ò–ô –¢–ê–ë–ë–ê–† ‚îÄ‚îÄ */
.tabbar{
  position:fixed;bottom:0;left:0;right:0;z-index:100;
  background:rgba(10,10,22,.96);
  backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);
  border-top:1px solid rgba(255,255,255,.06);
  display:flex;align-items:stretch;
  height:var(--tab-h);
  padding-bottom:env(safe-area-inset-bottom);
  box-shadow:0 -8px 32px rgba(0,0,0,.4);
}
.tabbar.hide{display:none}
.tab-item{
  flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:5px;cursor:pointer;position:relative;padding:8px 4px 10px;
  transition:opacity .15s;
  -webkit-user-select:none;user-select:none;
}
.tab-item:active{opacity:.7}
.tab-icon-wrap{
  position:relative;width:44px;height:32px;
  display:flex;align-items:center;justify-content:center;
  border-radius:14px;
  transition:background .22s ease, transform .18s ease;
}
.tab-item.active .tab-icon-wrap{
  background:rgba(124,58,237,.18);
  transform:translateY(-1px);
}
.tab-icon{
  font-size:22px;line-height:1;
  transition:transform .22s cubic-bezier(.34,1.56,.64,1),filter .22s;
  display:block;
}
.tab-item.active .tab-icon{
  transform:scale(1.12);
  filter:drop-shadow(0 0 6px rgba(168,85,247,.6));
  animation:tabPop .35s ease;
}
.tab-label{
  font-size:10px;font-weight:600;letter-spacing:.2px;
  color:var(--muted);transition:color .2s;
  line-height:1;
}
.tab-item.active .tab-label{
  color:var(--a2);
}
.tab-badge{
  position:absolute;top:-2px;right:2px;
  background:var(--red);
  color:#fff;font-size:9px;font-weight:800;
  border-radius:99px;padding:2px 6px;min-width:18px;text-align:center;
  display:none;border:2px solid rgba(10,10,22,.96);
  box-shadow:0 0 10px rgba(239,68,68,.6);
}
.tab-badge.on{display:block;animation:pop .35s cubic-bezier(.34,1.56,.64,1)}
/* –ú–∏–≥–∞–Ω–∏–µ –∏–∫–æ–Ω–∫–∏ –∫–æ—Ä–∑–∏–Ω—ã –∫–æ–≥–¥–∞ –µ—Å—Ç—å —Ç–æ–≤–∞—Ä—ã */
@keyframes cartPulse{0%,100%{filter:drop-shadow(0 0 0px rgba(239,68,68,0))}50%{filter:drop-shadow(0 0 8px rgba(239,68,68,.8))}}
.tab-item.has-items .tab-icon{animation:cartPulse 2s ease-in-out infinite}
.tab-item.has-items .tab-icon-wrap{background:rgba(239,68,68,.12)}
/* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏ */
.tab-dot{
  position:absolute;bottom:2px;left:50%;transform:translateX(-50%) scale(0);
  width:4px;height:4px;border-radius:50%;
  background:var(--a2);
  transition:transform .22s cubic-bezier(.34,1.56,.64,1);
  box-shadow:0 0 6px var(--a2);
}
.tab-item.active .tab-dot{transform:translateX(-50%) scale(1);animation:dotIn .25s ease}

/* ‚îÄ‚îÄ –ö–ù–û–ü–ö–ò ‚îÄ‚îÄ */
.btn{position:relative;overflow:hidden;display:inline-flex;align-items:center;justify-content:center;
  gap:7px;border:none;border-radius:14px;cursor:pointer;font-family:'Manrope',sans-serif;
  font-weight:700;font-size:14px;padding:13px 18px;
  transition:transform .13s,opacity .13s,box-shadow .2s;width:100%}
.btn:active{transform:scale(.96);opacity:.88}
.btn:disabled{opacity:.4;cursor:not-allowed;transform:none!important}
.bp{background:linear-gradient(135deg,var(--accent),var(--a2));color:#fff}
.bp:not(:disabled):hover{box-shadow:0 6px 28px rgba(124,58,237,.45)}
.bs{background:var(--bg3);color:var(--txt);border:1px solid var(--bdr)}
.bd{background:rgba(239,68,68,.1);color:var(--red);border:1px solid rgba(239,68,68,.25)}
.bsm{padding:7px 12px;font-size:12px;border-radius:10px;width:auto}
.rpl-el{position:absolute;border-radius:50%;background:rgba(255,255,255,.2);transform:scale(0);animation:rpl .55s linear;pointer-events:none}

/* ‚îÄ‚îÄ –•–ï–î–ï–† ‚îÄ‚îÄ */
.hdr{padding:10px 14px 8px;background:rgba(8,8,18,.95);backdrop-filter:blur(20px);border-bottom:1px solid var(--bdr);flex-shrink:0}
.hdr-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.logo{font-family:'Unbounded',sans-serif;font-size:15px;font-weight:800;
  background:linear-gradient(135deg,var(--a2),var(--gold));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.hbtns{display:flex;gap:7px}
.hbtn{background:var(--bg3);border:1px solid var(--bdr);border-radius:11px;padding:7px 11px;
  color:var(--txt);font-size:13px;cursor:pointer;transition:all .18s;position:relative;white-space:nowrap}
.hbtn:active{transform:scale(.92)}

/* ‚îÄ‚îÄ –ü–û–ò–°–ö –ò –ß–ò–ü–´ ‚îÄ‚îÄ */
.srch{position:relative;margin-bottom:7px}
.srch input{width:100%;background:var(--bg3);border:1.5px solid var(--bdr);border-radius:12px;
  padding:8px 12px 8px 35px;color:var(--txt);font-family:'Manrope',sans-serif;font-size:12px;outline:none;transition:border-color .2s}
.srch input:focus{border-color:var(--accent)}
.srch input::placeholder{color:var(--muted)}
.srch-ic{position:absolute;left:11px;top:50%;transform:translateY(-50%);font-size:13px;color:var(--muted);pointer-events:none}
.chips{display:flex;gap:7px;overflow-x:auto;scrollbar-width:none;padding-bottom:1px}
.chips::-webkit-scrollbar{display:none}
.chip{flex-shrink:0;background:var(--bg3);border:1px solid var(--bdr);border-radius:99px;padding:5px 12px;
  color:var(--muted);font-size:11px;font-weight:600;cursor:pointer;transition:all .18s;white-space:nowrap}
.chip.on{background:var(--accent);border-color:var(--accent);color:#fff;transform:scale(1.04)}

/* ‚îÄ‚îÄ –°–ö–†–û–õ–õ ‚îÄ‚îÄ */
.scr{flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;
  padding:12px;padding-bottom:calc(var(--tab-h) + 16px)}
.scr::-webkit-scrollbar{display:none}

/* ‚îÄ‚îÄ –û–ù–ë–û–†–î–ò–ù–ì ‚îÄ‚îÄ */
.ob-ico{font-size:78px;animation:float 3s ease-in-out infinite;display:block;margin-bottom:14px}
.ob-logo{font-family:'Unbounded',sans-serif;font-size:24px;font-weight:800;
  background:linear-gradient(135deg,var(--a2),var(--gold));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:6px}
.ob-sub{color:var(--muted);font-size:13px;line-height:1.6;margin-bottom:34px}
.role-cards{display:flex;flex-direction:column;gap:11px;width:100%;max-width:340px}
.rc{background:var(--bg2);border:2px solid var(--bdr);border-radius:19px;padding:17px 18px;
  cursor:pointer;text-align:left;display:flex;align-items:center;gap:14px;
  transition:all .22s cubic-bezier(.34,1.56,.64,1)}
.rc:active{transform:scale(.97)}
.rc.buyer:hover{border-color:var(--green);background:rgba(16,185,129,.06);transform:translateY(-2px)}
.rc.seller:hover{border-color:var(--gold);background:rgba(245,158,11,.06);transform:translateY(-2px)}
.rc-ico{font-size:36px;flex-shrink:0}
.rc-title{font-family:'Unbounded',sans-serif;font-size:13px;font-weight:700;margin-bottom:3px}
.rc-desc{font-size:11px;color:var(--muted)}
.rc-arr{color:var(--muted);font-size:17px;margin-left:auto;transition:transform .2s}
.rc:hover .rc-arr{transform:translateX(4px);color:var(--txt)}

/* ‚îÄ‚îÄ –ö–ê–†–¢–û–ß–ö–ò –°–û–ë–´–¢–ò–ô ‚îÄ‚îÄ */
.ev-list{display:flex;flex-direction:column;gap:9px}
.ev-card{background:var(--bg2);border:1.5px solid var(--bdr);border-radius:14px;overflow:hidden;
  cursor:pointer;transition:border-color .2s,transform .13s,box-shadow .2s;animation:fadeUp .3s ease both}
.ev-card:active{transform:scale(.985)}
.ev-card:hover{border-color:rgba(124,58,237,.4);box-shadow:0 4px 18px rgba(124,58,237,.1)}
.ev-inner{display:flex}
.ev-poster{width:88px;flex-shrink:0;background:var(--bg3);display:flex;align-items:center;
  justify-content:center;font-size:34px;min-height:106px;position:relative;overflow:hidden}
.ev-poster img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
.ev-pe{position:relative;z-index:1}
.ev-body{flex:1;padding:11px;display:flex;flex-direction:column;gap:4px}
.ev-cat{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--a2)}
.ev-title{font-family:'Unbounded',sans-serif;font-size:11px;font-weight:700;line-height:1.3}
.ev-meta{font-size:10px;color:var(--muted)}
.ev-foot{display:flex;align-items:center;justify-content:space-between;margin-top:3px}
.ev-price{font-family:'Unbounded',sans-serif;font-size:12px;font-weight:700;color:var(--green)}
.seat-tag{font-size:9px;font-weight:700;padding:2px 7px;border-radius:99px;background:var(--bg4);color:var(--muted)}
.seat-tag.low{color:var(--red);background:rgba(239,68,68,.1)}

/* ‚îÄ‚îÄ –î–ï–¢–ê–õ–ò –°–û–ë–´–¢–ò–Ø ‚îÄ‚îÄ */
.d-hero{height:185px;background:var(--bg3);display:flex;align-items:center;justify-content:center;
  font-size:66px;position:relative;overflow:hidden;flex-shrink:0}
.d-hero::after{content:'';position:absolute;bottom:0;left:0;right:0;height:65px;background:linear-gradient(transparent,var(--bg))}
.d-hero img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
.d-he{position:relative;z-index:1}
/* –ö–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥ –≤–Ω—É—Ç—Ä–∏ –¥–µ—Ç–∞–ª–µ–π ‚Äî —Ç–µ–ø–µ—Ä—å –∫—Ä–∞—Å–∏–≤–∞—è —Ç–∞–±–ª–µ—Ç–∫–∞ */
.back-pill{
  position:absolute;top:12px;left:12px;z-index:30;
  background:rgba(0,0,0,.65);backdrop-filter:blur(12px);
  border:1px solid rgba(255,255,255,.12);
  border-radius:99px;color:#fff;font-size:13px;font-weight:600;
  padding:8px 16px 8px 12px;
  display:flex;align-items:center;gap:6px;
  cursor:pointer;transition:all .18s;
  -webkit-appearance:none;outline:none;
}
.back-pill:active{background:rgba(0,0,0,.85);transform:scale(.94)}
.back-pill-arrow{font-size:16px;line-height:1}
.d-cat{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--a2);margin-bottom:5px}
.d-title{font-family:'Unbounded',sans-serif;font-size:17px;font-weight:800;line-height:1.2;margin-bottom:12px}
.ig{display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-bottom:12px}
.ib{background:var(--bg2);border:1px solid var(--bdr);border-radius:11px;padding:9px}
.ibl{font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:.6px;margin-bottom:2px}
.ibv{font-size:12px;font-weight:600}
.d-desc{background:var(--bg2);border:1px solid var(--bdr);border-radius:11px;padding:11px;
  font-size:12px;line-height:1.6;color:var(--muted);margin-bottom:12px}
.sec{font-family:'Unbounded',sans-serif;font-size:10px;font-weight:600;color:var(--muted);
  text-transform:uppercase;letter-spacing:1px;margin-bottom:8px}

/* ‚îÄ‚îÄ –ë–ò–õ–ï–¢–´ ‚îÄ‚îÄ */
.tt-list{display:flex;flex-direction:column;gap:7px;margin-bottom:12px}
.tt-card{background:var(--bg2);border:2px solid var(--bdr);border-radius:13px;padding:11px 13px;
  cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:space-between}
.tt-card.active-tt{border-color:var(--accent)!important;background:rgba(124,58,237,.08)!important}
.tt-card.soldout{opacity:.4;cursor:not-allowed}
.tt-card:not(.soldout):active{transform:scale(.98)}
.tt-nm{font-weight:700;font-size:13px;margin-bottom:2px}
.tt-av{font-size:10px;color:var(--muted)}
.tt-av.low{color:var(--red)}
.tt-pr{font-family:'Unbounded',sans-serif;font-size:13px;font-weight:700;color:var(--green)}
.tt-rd{width:19px;height:19px;border-radius:50%;border:2px solid var(--bdr);
  display:flex;align-items:center;justify-content:center;font-size:10px;
  transition:all .18s;flex-shrink:0;margin-left:8px}
.tt-card.active-tt .tt-rd{background:var(--accent);border-color:var(--accent);color:#fff}
.qty-row{display:flex;align-items:center;justify-content:space-between;
  background:var(--bg2);border:1px solid var(--bdr);border-radius:13px;padding:11px 13px;margin-bottom:13px}
.qty-lbl{font-size:13px;font-weight:600}
.qty-ctrl{display:flex;align-items:center;gap:13px}
.qty-btn{width:32px;height:32px;border-radius:50%;border:none;background:var(--bg4);color:var(--txt);
  font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .13s}
.qty-btn:active{background:var(--accent);transform:scale(.88)}
.qty-n{font-family:'Unbounded',sans-serif;font-size:18px;font-weight:700;min-width:22px;text-align:center}

/* ‚îÄ‚îÄ –®–¢–û–†–ö–ò ‚îÄ‚îÄ */
.sh-wrap{position:fixed;inset:0;z-index:200;display:flex;flex-direction:column;justify-content:flex-end;pointer-events:none}
.sh-wrap.on{pointer-events:all}
.sh-ov{position:absolute;inset:0;background:rgba(0,0,0,.65);opacity:0;transition:opacity .28s}
.sh-wrap.on .sh-ov{opacity:1}
.sh-body{position:relative;z-index:1;background:var(--bg2);border-radius:24px 24px 0 0;
  border-top:1px solid var(--bdr);max-height:90vh;display:flex;flex-direction:column;
  transform:translateY(100%);transition:transform .33s cubic-bezier(.34,1.56,.64,1)}
.sh-wrap.on .sh-body{transform:translateY(0)}
.sh-handle{width:36px;height:4px;background:var(--bdr);border-radius:99px;margin:10px auto 0}
.sh-hdr{padding:12px 16px;border-bottom:1px solid var(--bdr);display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.sh-title{font-family:'Unbounded',sans-serif;font-size:14px;font-weight:700}
.sh-x{background:var(--bg3);border:1px solid var(--bdr);border-radius:99px;width:28px;height:28px;
  cursor:pointer;font-size:13px;display:flex;align-items:center;justify-content:center;transition:background .18s}
.sh-x:active{background:var(--bg4)}
.sh-scr{overflow-y:auto;flex:1;padding:12px}
.sh-scr::-webkit-scrollbar{display:none}
.sh-foot{padding:10px 14px max(env(safe-area-inset-bottom),10px);border-top:1px solid var(--bdr);flex-shrink:0}

/* ‚îÄ‚îÄ –ö–û–†–ó–ò–ù–ê ‚îÄ‚îÄ */
.ci{background:var(--bg3);border:1px solid var(--bdr);border-radius:13px;padding:11px;margin-bottom:7px;animation:fadeUp .22s ease both}
.ci-title{font-weight:700;font-size:13px;margin-bottom:2px}
.ci-sub{font-size:11px;color:var(--muted);margin-bottom:8px}
.ci-foot{display:flex;align-items:center;justify-content:space-between}
.ci-price{font-family:'Unbounded',sans-serif;font-size:13px;font-weight:700;color:var(--green)}
.total-row{display:flex;align-items:center;justify-content:space-between;padding:11px 0;border-top:1px solid var(--bdr);margin-top:3px}
.total-lbl{font-size:12px;color:var(--muted)}
.total-val{font-family:'Unbounded',sans-serif;font-size:20px;font-weight:800}

/* ‚îÄ‚îÄ –£–°–ü–ï–• ‚îÄ‚îÄ */
#shSuccess .sh-body{
  background:linear-gradient(135deg,rgba(124,58,237,.14),rgba(168,85,247,.08)),var(--bg2);
  text-align:center;padding:28px 20px max(env(safe-area-inset-bottom),24px)}
.suc-ico{font-size:70px;display:block;margin-bottom:13px;animation:pop .45s .1s ease both}
.suc-title{font-family:'Unbounded',sans-serif;font-size:19px;font-weight:800;margin-bottom:7px}
.suc-sub{font-size:13px;color:var(--muted);line-height:1.6;margin-bottom:20px}

/* ‚îÄ‚îÄ –ö–ê–ë–ò–ù–ï–¢ ‚îÄ‚îÄ */
.sel-tabs{display:flex;background:var(--bg2);border-bottom:1px solid var(--bdr);
  flex-shrink:0;overflow-x:auto;scrollbar-width:none}
.sel-tabs::-webkit-scrollbar{display:none}
.s-tab{flex:1;min-width:65px;padding:11px 5px;text-align:center;font-size:10px;font-weight:600;
  color:var(--muted);cursor:pointer;border-bottom:2px solid transparent;transition:all .18s;white-space:nowrap}
.s-tab.on{color:var(--accent);border-bottom-color:var(--accent)}
.stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:9px;margin-bottom:14px}
.stat-card{background:var(--bg2);border:1px solid var(--bdr);border-radius:14px;padding:13px;animation:fadeUp .3s ease both}
.st-ico{font-size:22px;margin-bottom:5px}
.st-val{font-family:'Unbounded',sans-serif;font-size:18px;font-weight:800;margin-bottom:1px}
.st-lbl{font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:.4px}
.prog-bar{height:3px;background:var(--bg4);border-radius:99px;overflow:hidden;margin:6px 0 3px}
.prog-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--a2));border-radius:99px;transition:width .55s ease}

/* ‚îÄ‚îÄ –§–û–†–ú–´ ‚îÄ‚îÄ */
.fld{margin-bottom:11px}
.fl{font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px;display:block}
.fi{width:100%;background:var(--bg3);border:1.5px solid var(--bdr);border-radius:12px;padding:10px 13px;
  color:var(--txt);font-family:'Manrope',sans-serif;font-size:13px;outline:none;transition:border-color .2s;-webkit-appearance:none}
.fi:focus{border-color:var(--accent)}
.fi::placeholder{color:var(--muted)}
select.fi option{background:var(--bg2)}
textarea.fi{resize:vertical;min-height:70px}
.frow{display:grid;grid-template-columns:1fr 1fr;gap:9px}
.img-upload{border:2px dashed var(--bdr);border-radius:14px;padding:18px;text-align:center;
  cursor:pointer;transition:border-color .2s;margin-bottom:11px;position:relative;overflow:hidden}
.img-upload:hover{border-color:var(--accent)}
.img-upload input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%}
.img-preview{width:100%;max-height:160px;object-fit:cover;border-radius:10px;margin-top:8px;display:none}
.img-preview.on{display:block}
.img-upload-ico{font-size:32px;margin-bottom:6px}
.img-upload-txt{font-size:12px;color:var(--muted)}
.img-upload-url{margin-top:8px}

/* ‚îÄ‚îÄ –ü–†–û–ú–û ‚îÄ‚îÄ */
.promo-card{background:var(--bg2);border:1px solid var(--bdr);border-radius:13px;padding:11px 13px;
  margin-bottom:7px;display:flex;align-items:center;justify-content:space-between;animation:fadeUp .25s ease both}
.pc{font-family:'Unbounded',sans-serif;font-size:12px;font-weight:700;color:var(--a2)}
.pi{font-size:10px;color:var(--muted);margin-top:2px}

/* ‚îÄ‚îÄ –°–ö–ê–ù–ï–† ‚îÄ‚îÄ */
.scan-box{background:var(--bg2);border:2px dashed var(--bdr);border-radius:18px;padding:26px 14px;
  text-align:center;margin-bottom:13px;transition:border-color .28s}
.scan-box.act{border-color:var(--accent);animation:glow 2s ease infinite}
.scan-res{background:var(--bg2);border-radius:13px;padding:13px;border:2px solid;margin-bottom:11px;animation:fadeUp .28s ease}
.scan-res.ok{border-color:var(--green)}.scan-res.used{border-color:var(--red)}.scan-res.bad{border-color:var(--muted)}

/* ‚îÄ‚îÄ –°–û–ë–´–¢–ò–Ø –ö–ê–ë–ò–ù–ï–¢–ê ‚îÄ‚îÄ */
.ev-mgmt-card{background:var(--bg2);border:1px solid var(--bdr);border-radius:13px;padding:12px;margin-bottom:8px;animation:fadeUp .28s ease both}
.ev-mgmt-title{font-weight:700;font-size:13px;margin-bottom:3px}
.ev-mgmt-sub{font-size:11px;color:var(--muted);margin-bottom:9px}
.ev-mgmt-foot{display:flex;gap:7px}

/* ‚îÄ‚îÄ –¢–ê–ô–ú–ï–† –ö–û–†–ó–ò–ù–´ ‚îÄ‚îÄ */
@keyframes timerPulse{0%,100%{opacity:1}50%{opacity:.55}}
@keyframes timerExpire{0%{transform:scale(1)}50%{transform:scale(1.04)}100%{transform:scale(1)}}
.cart-timer{
  display:flex;align-items:center;gap:8px;
  background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.25);
  border-radius:13px;padding:10px 13px;margin-bottom:11px;
}
.cart-timer.warn{background:rgba(245,158,11,.1);border-color:rgba(245,158,11,.35)}
.cart-timer.ok{background:rgba(16,185,129,.08);border-color:rgba(16,185,129,.25)}
.timer-ico{font-size:20px;flex-shrink:0}
.timer-body{flex:1}
.timer-label{font-size:10px;color:var(--muted);margin-bottom:2px}
.timer-val{font-family:'Unbounded',sans-serif;font-size:18px;font-weight:800;letter-spacing:.5px;transition:color .3s}
.timer-bar-wrap{height:3px;background:var(--bg4);border-radius:99px;overflow:hidden;margin-top:5px}
.timer-bar{height:100%;border-radius:99px;transition:width 1s linear, background .5s}

/* ‚îÄ‚îÄ –ö–ù–û–ü–ö–ò –ö–û–†–ó–ò–ù–´ ‚îÄ‚îÄ */
.cart-actions{display:flex;gap:9px}
.btn-cancel{background:var(--bg3);color:var(--muted);border:1px solid var(--bdr);border-radius:14px;
  padding:13px 18px;font-family:'Manrope',sans-serif;font-weight:700;font-size:14px;
  cursor:pointer;flex:1;transition:all .15s;position:relative;overflow:hidden}
.btn-cancel:active{transform:scale(.96);background:rgba(239,68,68,.1);color:var(--red);border-color:rgba(239,68,68,.3)}
.skel{background:linear-gradient(90deg,var(--bg2) 25%,var(--bg3) 50%,var(--bg2) 75%);
  background-size:200% 100%;animation:shimmer 1.4s infinite;border-radius:8px}
.toast{position:fixed;top:18px;left:50%;transform:translateX(-50%) translateY(-120px);
  background:var(--bg3);border:1px solid var(--bdr);border-radius:12px;padding:9px 16px;
  font-size:12px;font-weight:600;z-index:999;transition:transform .33s cubic-bezier(.34,1.56,.64,1);
  white-space:nowrap;box-shadow:0 8px 30px rgba(0,0,0,.5)}
.toast.show{transform:translateX(-50%) translateY(0)}
.toast.ok{border-color:var(--green);color:var(--green)}
.toast.err{border-color:var(--red);color:var(--red)}
.ld{width:18px;height:18px;border:2px solid rgba(255,255,255,.2);border-top-color:#fff;border-radius:50%;animation:spin .6s linear infinite}
.empty{display:flex;flex-direction:column;align-items:center;padding:42px 14px;gap:9px;color:var(--muted);text-align:center}
.empty-ico{font-size:48px;animation:bounce 2s ease-in-out infinite}
.divider{height:1px;background:var(--bdr);margin:12px 0}
.tag-hot{display:inline-block;font-size:9px;font-weight:700;padding:1px 6px;border-radius:99px;background:var(--gold);color:#000;margin-left:5px}
</style>
</head>
<body>

<div class="toast" id="toast"></div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –ù–ò–ñ–ù–ò–ô –¢–ê–ë–ë–ê–† ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<nav class="tabbar hide" id="mainTabbar">
  <div class="tab-item active" id="tab-events" onclick="APP.tabNav('events')">
    <div class="tab-icon-wrap">
      <span class="tab-icon">üé´</span>
    </div>
    <span class="tab-label">–°–æ–±—ã—Ç–∏—è</span>
    <span class="tab-dot"></span>
  </div>
  <div class="tab-item" id="tab-cart" onclick="APP.tabNav('cart')">
    <div class="tab-icon-wrap">
      <span class="tab-icon">üõí</span>
      <span class="tab-badge" id="tabCartBadge"></span>
    </div>
    <span class="tab-label">–ö–æ—Ä–∑–∏–Ω–∞</span>
    <span class="tab-dot"></span>
  </div>
  <div class="tab-item" id="tab-cabinet" onclick="APP.tabNav('cabinet')">
    <div class="tab-icon-wrap">
      <span class="tab-icon">üè™</span>
    </div>
    <span class="tab-label">–ö–∞–±–∏–Ω–µ—Ç</span>
    <span class="tab-dot"></span>
  </div>
</nav>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –û–ù–ë–û–†–î–ò–ù–ì ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page" id="pgOnboard">
  <span class="ob-ico">üéü</span>
  <div class="ob-logo">TicketBot</div>
  <div class="ob-sub">–ü–æ–∫—É–ø–∞–π –∏ –ø—Ä–æ–¥–∞–≤–∞–π –±–∏–ª–µ—Ç—ã<br>–Ω–∞ –ª—É—á—à–∏–µ —Å–æ–±—ã—Ç–∏—è –≤ Telegram</div>
  <div class="role-cards">
    <div class="rc buyer" style="animation:fadeUp .35s .1s ease both" onclick="APP.chooseRole('buyer')">
      <span class="rc-ico">üé´</span>
      <div><div class="rc-title">–Ø –ø–æ–∫—É–ø–∞—Ç–µ–ª—å</div><div class="rc-desc">–ò—â—É —Å–æ–±—ã—Ç–∏—è –∏ –ø–æ–∫—É–ø–∞—é –±–∏–ª–µ—Ç—ã</div></div>
      <span class="rc-arr">‚Üí</span>
    </div>
    <div class="rc seller" style="animation:fadeUp .35s .2s ease both" onclick="APP.chooseRole('seller')">
      <span class="rc-ico">üè™</span>
      <div><div class="rc-title">–Ø –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä</div><div class="rc-desc">–°–æ–∑–¥–∞—é —Å–æ–±—ã—Ç–∏—è –∏ –ø—Ä–æ–¥–∞—é –±–∏–ª–µ—Ç—ã</div></div>
      <span class="rc-arr">‚Üí</span>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –°–û–ë–´–¢–ò–Ø ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page hide" id="pgBuyer">
  <div class="hdr">
    <div class="hdr-top">
      <div class="logo">üéü TicketBot</div>
    </div>
    <div class="srch"><span class="srch-ic">üîç</span>
      <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ —Å–æ–±—ã—Ç–∏–π..." oninput="APP.filterEvents()">
    </div>
    <div class="chips" id="chipsBar"></div>
  </div>
  <div class="scr" id="evList"></div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –î–ï–¢–ê–õ–ò –°–û–ë–´–¢–ò–Ø ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page hide" id="pgDetail">
  <div class="d-hero" id="dHero">
    <button class="back-pill" id="detailBackBtn">
      <span class="back-pill-arrow">‚Üê</span>
      <span>–ù–∞–∑–∞–¥</span>
    </button>
    <span class="d-he" id="dEmoji"></span>
  </div>
  <div class="scr" style="padding-top:0;padding-bottom:calc(var(--tab-h) + 80px)">
    <div style="padding:12px">
      <div class="d-cat" id="dCat"></div>
      <div class="d-title" id="dTitle"></div>
      <div class="ig" id="dGrid"></div>
      <div class="d-desc" id="dDesc"></div>
      <div class="sec">üé´ –¢–∏–ø –±–∏–ª–µ—Ç–∞</div>
      <div class="tt-list" id="ttList"></div>
      <div class="qty-row">
        <span class="qty-lbl">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</span>
        <div class="qty-ctrl">
          <button class="qty-btn" onclick="APP.changeQty(-1)">‚àí</button>
          <span class="qty-n" id="qtyNum">1</span>
          <button class="qty-btn" onclick="APP.changeQty(1)">+</button>
        </div>
      </div>
    </div>
  </div>
  <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è: z-index –≤—ã—à–µ —Ç–∞–±–±–∞—Ä–∞, —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∞–¥ –Ω–∏–º -->
  <div style="
    position:fixed;
    bottom:calc(var(--tab-h) + env(safe-area-inset-bottom));
    left:0;right:0;
    padding:10px 14px 12px;
    background:rgba(8,8,18,.97);
    backdrop-filter:blur(20px);
    border-top:1px solid var(--bdr);
    z-index:110;
    display:none;
  " id="addBtnBar">
    <button class="btn bp" id="addBtn" onclick="APP.addToCart()" disabled>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –±–∏–ª–µ—Ç–∞</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –ö–û–†–ó–ò–ù–ê (–®–¢–û–†–ö–ê) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="sh-wrap" id="shCart">
  <div class="sh-ov" id="cartOv"></div>
  <div class="sh-body">
    <div class="sh-handle"></div>
    <div class="sh-hdr">
      <span class="sh-title">üõí –ö–æ—Ä–∑–∏–Ω–∞</span>
      <div class="sh-x" onclick="APP.closeCart()">‚úï</div>
    </div>
    <div class="sh-scr" id="cartContent"></div>
    <div class="sh-foot">
      <div class="cart-actions">
        <button class="btn-cancel" id="cancelBtn" onclick="APP.cancelCart()">‚úï –û—Ç–º–µ–Ω–∏—Ç—å</button>
        <button class="btn bp" id="payBtn" onclick="APP.pay()" style="flex:2">üí≥ –û–ø–ª–∞—Ç–∏—Ç—å</button>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –£–°–ü–ï–• ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="sh-wrap" id="shSuccess">
  <div class="sh-ov"></div>
  <div class="sh-body">
    <div class="sh-handle"></div>
    <span class="suc-ico">üéâ</span>
    <div class="suc-title">–ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω!</div>
    <div class="suc-sub">–ë–∏–ª–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ –±–æ—Ç! üéü<br>–ë–æ—Ç –ø—Ä–∏—à–ª—ë—Ç PDF —Å QR-–∫–æ–¥–æ–º –¥–ª—è –ø—Ä–æ—Ö–æ–¥–∞.</div>
    <button class="btn bp" onclick="APP.closeSuccess()">‚úÖ –û—Ç–ª–∏—á–Ω–æ!</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –ö–ê–ë–ò–ù–ï–¢ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page hide" id="pgSeller">
  <div class="hdr">
    <div class="hdr-top">
      <div class="logo">üè™ –ö–∞–±–∏–Ω–µ—Ç</div>
    </div>
    <div class="sel-tabs" id="selTabs">
      <div class="s-tab on" onclick="APP.sellerTab('stats')">üìä –°—Ç–∞—Ç</div>
      <div class="s-tab" onclick="APP.sellerTab('events')">üìÖ –°–æ–±—ã—Ç–∏—è</div>
      <div class="s-tab" onclick="APP.sellerTab('add')">‚ûï –î–æ–±–∞–≤–∏—Ç—å</div>
      <div class="s-tab" onclick="APP.sellerTab('scan')">üì∑ –°–∫–∞–Ω–µ—Ä</div>
      <div class="s-tab" onclick="APP.sellerTab('promo')">üè∑ –ü—Ä–æ–º–æ</div>
    </div>
  </div>
  <div class="scr" id="selContent"></div>
</div>

<script>
const CFG = {
  API: "https://changed-climate-well-collecting.trycloudflare.com",
  CURRENCY: "—Å—É–º",
  MAX_QTY: 8
};

const TG = window.Telegram?.WebApp || null;
if (TG) { TG.ready(); TG.expand(); TG.setHeaderColor?.('#080812'); TG.setBackgroundColor?.('#080812'); }
const TG_USER_ID   = TG?.initDataUnsafe?.user?.id || null;
const TG_INIT_DATA = TG?.initData || '';

const CAT = {all:"üåê –í—Å–µ",concert:"üéµ –ö–æ–Ω—Ü–µ—Ä—Ç—ã",theater:"üé≠ –¢–µ–∞—Ç—Ä",sport:"‚öΩ –°–ø–æ—Ä—Ç",exhibition:"üñº –í—ã—Å—Ç–∞–≤–∫–∏",festival:"üé™ –§–µ—Å—Ç–∏–≤–∞–ª–∏",other:"üé° –î—Ä—É–≥–æ–µ"};

const APP = (() => {
  const CART_TTL = 15 * 60; // 15 –º–∏–Ω—É—Ç –≤ —Å–µ–∫—É–Ω–¥–∞—Ö

  let state = {
    role:          '',
    cart:          JSON.parse(localStorage.getItem('tb_cart') || '[]'),
    cartExpireAt:  parseInt(localStorage.getItem('tb_cart_expire') || '0'), // timestamp ms
    events:        [],
    curEvent:      null,
    curTicketType: null,
    qty:           1,
    filter:        'all',
    activeTab:     'events',
    currentSelTab: 'stats',
    _timerInterval: null,
  };

  // –ï—Å–ª–∏ –∫–æ—Ä–∑–∏–Ω–∞ —É–∂–µ –∏—Å—Ç–µ–∫–ª–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ ‚Äî –æ—á–∏—â–∞–µ–º
  if(state.cartExpireAt && Date.now() > state.cartExpireAt){
    state.cart = []; state.cartExpireAt = 0;
    localStorage.removeItem('tb_cart'); localStorage.removeItem('tb_cart_expire');
  }

  // ‚îÄ‚îÄ –£–¢–ò–õ–ò–¢–´ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function fmt(n){ return Number(n).toLocaleString('ru') + ' ' + CFG.CURRENCY; }
  function haptic(t){
    TG?.HapticFeedback?.selectionChanged?.();
    if(t==='success') TG?.HapticFeedback?.notificationOccurred?.('success');
    if(t==='error')   TG?.HapticFeedback?.notificationOccurred?.('error');
  }
  function showToast(msg, type=''){
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.className = 'toast ' + type + ' show';
    clearTimeout(el._t);
    el._t = setTimeout(() => el.classList.remove('show'), 2700);
  }

  // ‚îÄ‚îÄ –¢–ê–ô–ú–ï–† ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function _startTimer(){
    _stopTimer();
    if(!state.cartExpireAt) return;
    state._timerInterval = setInterval(() => {
      const left = Math.max(0, Math.floor((state.cartExpireAt - Date.now()) / 1000));
      _renderTimerBlock(left);
      if(left <= 0){ _expireCart(); }
    }, 1000);
    _renderTimerBlock(Math.max(0, Math.floor((state.cartExpireAt - Date.now()) / 1000)));
  }

  function _stopTimer(){
    if(state._timerInterval){ clearInterval(state._timerInterval); state._timerInterval = null; }
  }

  function _renderTimerBlock(secsLeft){
    const el = document.getElementById('cartTimerBlock'); if(!el) return;
    const m = Math.floor(secsLeft / 60), s = secsLeft % 60;
    const pct = Math.min(100, (secsLeft / CART_TTL) * 100);
    const isWarn = secsLeft < 120, isOk = secsLeft >= 300;
    const color = isOk ? 'var(--green)' : isWarn ? 'var(--red)' : 'var(--gold)';
    const timerClass = isOk ? 'ok' : isWarn ? '' : 'warn';
    el.className = 'cart-timer ' + timerClass;
    el.innerHTML = `
      <span class="timer-ico">${isWarn && secsLeft < 60 ? 'üî¥' : '‚è±'}</span>
      <div class="timer-body">
        <div class="timer-label">–ú–µ—Å—Ç–∞ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω—ã –Ω–∞</div>
        <div class="timer-val" style="color:${color}">${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}</div>
        <div class="timer-bar-wrap">
          <div class="timer-bar" style="width:${pct}%;background:${color}"></div>
        </div>
      </div>`;
  }

  function _expireCart(){
    _stopTimer();
    state.cart = []; state.cartExpireAt = 0;
    localStorage.removeItem('tb_cart'); localStorage.removeItem('tb_cart_expire');
    updateCartUI();
    closeCart();
    haptic('error');
    showToast('‚è∞ –í—Ä–µ–º—è –≤—ã—à–ª–æ ‚Äî –±—Ä–æ–Ω—å –æ—Ç–º–µ–Ω–µ–Ω–∞', 'err');
  }

  // ‚îÄ‚îÄ –ù–ê–í–ò–ì–ê–¶–ò–Ø ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function goTo(pageId){
    document.querySelectorAll('.page').forEach(p => {
      p.classList.add('hide');
      p.style.transition = 'none';
    });
    const pg = document.getElementById(pageId);
    if (!pg) return;
    pg.classList.remove('hide');
    pg.style.opacity = '0';
    pg.style.transform = 'translateY(10px)';
    requestAnimationFrame(() => requestAnimationFrame(() => {
      pg.style.transition = 'opacity .22s ease, transform .22s ease';
      pg.style.opacity = '1';
      pg.style.transform = 'translateY(0)';
    }));
  }

  // ‚îÄ‚îÄ –¢–ê–ë–ë–ê–† ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function tabNav(tab){
    haptic();
    // –ï—Å–ª–∏ –Ω–∞–∂–∞–ª–∏ –∫–æ—Ä–∑–∏–Ω—É ‚Äî –æ—Ç–∫—Ä—ã–≤–∞–µ–º —à—Ç–æ—Ä–∫—É, –Ω–µ –º–µ–Ω—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
    if(tab === 'cart'){
      openCart();
      return;
    }
    state.activeTab = tab;
    // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —Ç–∞–±
    document.querySelectorAll('.tab-item').forEach(el => el.classList.remove('active'));
    document.getElementById('tab-' + tab)?.classList.add('active');
    if(tab === 'events'){
      if(state.role !== 'buyer') state.role = 'buyer';
      localStorage.setItem('tb_role','buyer');
      loadEvents();
      goTo('pgBuyer');
    } else if(tab === 'cabinet'){
      if(state.role !== 'seller') state.role = 'seller';
      localStorage.setItem('tb_role','seller');
      goTo('pgSeller');
      sellerTab('stats');
    }
  }

  function _showTabbar(){ document.getElementById('mainTabbar')?.classList.remove('hide'); }
  function _hideTabbar(){ document.getElementById('mainTabbar')?.classList.add('hide'); }

  function _setActiveTab(tab){
    state.activeTab = tab;
    document.querySelectorAll('.tab-item').forEach(el => el.classList.remove('active'));
    document.getElementById('tab-' + tab)?.classList.add('active');
  }

  // ‚îÄ‚îÄ –†–û–õ–¨ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function chooseRole(role){
    haptic();
    state.role = role;
    localStorage.setItem('tb_role', role);
    _showTabbar();
    if(role === 'buyer'){
      _setActiveTab('events');
      loadEvents();
      goTo('pgBuyer');
    } else {
      _setActiveTab('cabinet');
      goTo('pgSeller');
      sellerTab('stats');
    }
  }

  // switchRole –æ—Å—Ç–∞–≤–ª–µ–Ω –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ (—Ç–µ–ø–µ—Ä—å –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ UI)
  function switchRole(){
    const newRole = state.role === 'buyer' ? 'seller' : 'buyer';
    chooseRole(newRole);
  }

  // ‚îÄ‚îÄ –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ö–ù–û–ü–ö–ò –ù–ê–ó–ê–î ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function _initEvents(){
    // –ö–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥ –≤ –¥–µ—Ç–∞–ª—è—Ö —Å–æ–±—ã—Ç–∏—è
    document.getElementById('detailBackBtn')?.addEventListener('click', () => {
      haptic();
      document.getElementById('addBtnBar').style.display = 'none';
      _setActiveTab('events');
      goTo('pgBuyer');
    });
    // –û–≤–µ—Ä–ª–µ–π –∫–æ—Ä–∑–∏–Ω—ã
    document.getElementById('cartOv')?.addEventListener('click', closeCart);
  }

  // ‚îÄ‚îÄ API ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function apiFetch(path, options = {}){
    const headers = {
      'Content-Type': 'application/json',
      'X-User-Id':    TG_USER_ID || '',
      'X-Init-Data':  TG_INIT_DATA,
      ...(options.headers || {})
    };
    const resp = await fetch(CFG.API + path, { ...options, headers });
    if (!resp.ok) throw new Error('HTTP ' + resp.status);
    return resp.json();
  }

  // ‚îÄ‚îÄ –°–û–ë–´–¢–ò–Ø ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function loadEvents(){
    renderSkeletons();
    try { const data = await apiFetch('/api/events'); state.events = data; }
    catch { state.events = DEMO_EVENTS; }
    renderChips();
    filterEvents();
  }

  function renderSkeletons(){
    document.getElementById('evList').innerHTML =
      '<div class="ev-list">' + [1,2,3].map(i => `
        <div class="ev-card" style="animation-delay:${i*.08}s">
          <div class="ev-inner">
            <div class="ev-poster skel" style="min-height:106px;width:88px"></div>
            <div class="ev-body" style="gap:8px">
              ${[55,88,68,48].map(w => `<div class="skel" style="height:9px;width:${w}%"></div>`).join('')}
            </div>
          </div>
        </div>`).join('') + '</div>';
  }

  function renderChips(){
    const cats = ['all', ...new Set(state.events.map(e => e.category))];
    document.getElementById('chipsBar').innerHTML =
      cats.map(c => `<div class="chip ${c===state.filter?'on':''}" onclick="APP.setFilter('${c}')">${CAT[c]||c}</div>`).join('');
  }

  function setFilter(c){ state.filter = c; haptic(); renderChips(); filterEvents(); }

  function filterEvents(){
    const q = (document.getElementById('searchInput')?.value || '').toLowerCase();
    const f = state.events.filter(e =>
      (state.filter === 'all' || e.category === state.filter) &&
      (!q || e.title.toLowerCase().includes(q) || (e.city||'').toLowerCase().includes(q))
    );
    renderEvents(f);
  }

  function renderEvents(list){
    const el = document.getElementById('evList');
    if(!list.length){
      el.innerHTML = '<div class="empty"><div class="empty-ico">üîç</div><div>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div></div>';
      return;
    }
    el.innerHTML = '<div class="ev-list">' + list.map((ev, i) => {
      const mp  = Math.min(...ev.ticket_types.map(t => t.price));
      const ta  = ev.ticket_types.reduce((s,t) => s + t.available, 0);
      const low = ta <= 20;
      return `<div class="ev-card" style="animation-delay:${i*.05}s" onclick="APP.openEvent(${ev.id})">
        <div class="ev-inner">
          <div class="ev-poster">
            ${ev.poster_url ? `<img src="${ev.poster_url}" loading="lazy">` : ''}
            <span class="ev-pe">${ev.emoji||'üé°'}</span>
          </div>
          <div class="ev-body">
            <div class="ev-cat">${CAT[ev.category]||ev.category}</div>
            <div class="ev-title">${ev.title}</div>
            <div class="ev-meta">üìÖ ${ev.date} ¬∑ ${ev.time}</div>
            <div class="ev-meta">üìç ${ev.venue}, ${ev.city}</div>
            <div class="ev-foot">
              <div class="ev-price">–æ—Ç ${fmt(mp)}</div>
              <div class="seat-tag ${low?'low':''}">${low?'üî• ':''}${ta} –º–µ—Å—Ç</div>
            </div>
          </div>
        </div>
      </div>`;
    }).join('') + '</div>';
  }

  // ‚îÄ‚îÄ –î–ï–¢–ê–õ–ò –°–û–ë–´–¢–ò–Ø ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function openEvent(id){
    const ev = state.events.find(e => e.id === id);
    if(!ev) return;
    state.curEvent = ev; state.curTicketType = null; state.qty = 1;

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å –∫–Ω–æ–ø–∫–∏
    document.getElementById('addBtnBar').style.display = 'block';

    const hero = document.getElementById('dHero');
    hero.querySelectorAll('img').forEach(i => i.remove());
    if(ev.poster_url){
      const img = new Image();
      img.src = ev.poster_url;
      img.style.cssText = 'position:absolute;inset:0;width:100%;height:100%;object-fit:cover';
      hero.appendChild(img);
    }
    document.getElementById('dEmoji').textContent = ev.emoji || 'üé°';
    document.getElementById('dCat').textContent   = CAT[ev.category] || ev.category;
    document.getElementById('dTitle').textContent = ev.title;
    document.getElementById('qtyNum').textContent = '1';

    const dd = document.getElementById('dDesc');
    if(ev.description){ dd.style.display='block'; dd.textContent=ev.description; }
    else dd.style.display='none';

    document.getElementById('dGrid').innerHTML = `
      <div class="ib"><div class="ibl">üìÖ –î–∞—Ç–∞</div><div class="ibv">${ev.date}</div></div>
      <div class="ib"><div class="ibl">üïê –í—Ä–µ–º—è</div><div class="ibv">${ev.time}</div></div>
      <div class="ib"><div class="ibl">üìç –ú–µ—Å—Ç–æ</div><div class="ibv">${ev.venue}</div></div>
      <div class="ib"><div class="ibl">üîû –í–æ–∑—Ä–∞—Å—Ç</div><div class="ibv">${ev.age_rating}</div></div>`;

    document.getElementById('ttList').innerHTML = ev.ticket_types.map(tt => {
      const so  = tt.available === 0;
      const low = !so && tt.available <= 10;
      return `<div class="tt-card ${so?'soldout':''}" id="tt_${tt.id}" onclick="${so ? '' : `APP.selectTicket(${tt.id})`}">
        <div>
          <div class="tt-nm">${tt.name}${low?'<span class="tag-hot">–ú–∞–ª–æ</span>':''}</div>
          <div class="tt-av ${low?'low':''}">${so ? '–ù–µ—Ç –º–µ—Å—Ç' : `${tt.available}/${tt.total} –º–µ—Å—Ç`}</div>
        </div>
        <div style="display:flex;align-items:center">
          <div class="tt-pr">${fmt(tt.price)}</div>
          <div class="tt-rd" id="rd_${tt.id}">${so?'‚úï':''}</div>
        </div>
      </div>`;
    }).join('');

    updateAddBtn(); haptic();
    goTo('pgDetail');
  }

  function selectTicket(ttId){
    if(!state.curEvent) return;
    const tt = state.curEvent.ticket_types.find(t => t.id === ttId);
    if(!tt || tt.available === 0) return;
    state.curTicketType = tt; state.qty = 1;
    state.curEvent.ticket_types.forEach(t => {
      document.getElementById('tt_'+t.id)?.classList.remove('active-tt');
      const rd = document.getElementById('rd_'+t.id);
      if(rd && t.available > 0) rd.textContent = '';
    });
    document.getElementById('tt_'+ttId)?.classList.add('active-tt');
    const rd = document.getElementById('rd_'+ttId);
    if(rd) rd.textContent = '‚úì';
    document.getElementById('qtyNum').textContent = '1';
    haptic(); updateAddBtn();
  }

  function changeQty(d){
    if(!state.curTicketType) return;
    state.qty = Math.max(1, Math.min(Math.min(state.curTicketType.available, CFG.MAX_QTY), state.qty + d));
    document.getElementById('qtyNum').textContent = state.qty;
    haptic(); updateAddBtn();
  }

  function updateAddBtn(){
    const b = document.getElementById('addBtn'); if(!b) return;
    if(!state.curTicketType){
      b.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –±–∏–ª–µ—Ç–∞'; b.disabled = true;
    } else {
      b.textContent = `üõí –í –∫–æ—Ä–∑–∏–Ω—É ‚Äî ${fmt(state.curTicketType.price * state.qty)}`; b.disabled = false;
    }
  }

  // ‚îÄ‚îÄ –ö–û–†–ó–ò–ù–ê: –°–û–•–†–ê–ù–ï–ù–ò–ï (—Å–µ—Ä–≤–µ—Ä + localStorage –∫–∞–∫ fallback) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function _syncCartToServer(){
    if(!TG_USER_ID) return;                      // –Ω–µ—Ç user_id ‚Äî —Ç–æ–ª—å–∫–æ localStorage
    try {
      const res = await apiFetch('/api/cart', {
        method: 'POST',
        body: JSON.stringify({ items: state.cart })
      });
      // –°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –∞–∫—Ç—É–∞–ª—å–Ω—ã–π expire_at ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º
      if(res.expire_at){
        state.cartExpireAt = res.expire_at;
        localStorage.setItem('tb_cart_expire', String(res.expire_at));
      }
    } catch(e) {
      console.warn('Cart sync failed, using localStorage only:', e);
    }
  }

  async function _loadCartFromServer(){
    if(!TG_USER_ID) return false;
    try {
      const res = await apiFetch('/api/cart');
      if(res.items && res.items.length > 0){
        state.cart       = res.items;
        state.cartExpireAt = res.expire_at || 0;
        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –≤ localStorage —Ç–æ–∂–µ
        localStorage.setItem('tb_cart',        JSON.stringify(state.cart));
        localStorage.setItem('tb_cart_expire', String(state.cartExpireAt));
        return true;
      } else {
        // –°–µ—Ä–≤–µ—Ä –≥–æ–≤–æ—Ä–∏—Ç –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞ ‚Äî —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –∏ –ª–æ–∫–∞–ª—å–Ω–æ
        state.cart = []; state.cartExpireAt = 0;
        localStorage.removeItem('tb_cart'); localStorage.removeItem('tb_cart_expire');
        return false;
      }
    } catch(e) {
      console.warn('Could not load cart from server, using localStorage:', e);
      return false;
    }
  }

  async function _clearCartOnServer(){
    if(!TG_USER_ID) return;
    try { await apiFetch('/api/cart', { method: 'DELETE' }); } catch {}
  }

  function addToCart(){
    if(!state.curTicketType || !state.curEvent) return;
    const ev = state.curEvent, tt = state.curTicketType;
    const ex = state.cart.find(c => c.tt_id === tt.id);
    if(ex) ex.qty = Math.min(ex.qty + state.qty, CFG.MAX_QTY);
    else state.cart.push({
      event_id: ev.id, event_title: ev.title, event_date: ev.date,
      event_time: ev.time, event_age: ev.age_rating, venue: ev.venue,
      tt_id: tt.id, tt_name: tt.name, price: tt.price, qty: state.qty
    });
    state.cartExpireAt = Date.now() + CART_TTL * 1000;
    saveCart();
    _syncCartToServer();
    haptic('success');
    showToast('‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–æ—Ä–∑–∏–Ω—É!', 'ok');
    document.getElementById('addBtnBar').style.display = 'none';
    _setActiveTab('events');
    goTo('pgBuyer');
  }

  function saveCart(){
    localStorage.setItem('tb_cart', JSON.stringify(state.cart));
    if(state.cart.length && state.cartExpireAt)
      localStorage.setItem('tb_cart_expire', String(state.cartExpireAt));
    else
      localStorage.removeItem('tb_cart_expire');
    updateCartUI();
  }

  function updateCartUI(){
    const tq = state.cart.reduce((s,i) => s + i.qty, 0);
    const cartTab = document.getElementById('tab-cart');
    const b = document.getElementById('tabCartBadge');
    if(b){ b.textContent = tq || ''; b.classList.toggle('on', tq > 0); }
    if(cartTab){ cartTab.classList.toggle('has-items', tq > 0); }
    if(!tq){ _stopTimer(); state.cartExpireAt = 0; localStorage.removeItem('tb_cart_expire'); }
  }

  function cancelCart(){
    haptic();
    state.cart = []; state.cartExpireAt = 0;
    _stopTimer();
    localStorage.removeItem('tb_cart'); localStorage.removeItem('tb_cart_expire');
    _clearCartOnServer();
    updateCartUI(); closeCart();
    showToast('üóë –ö–æ—Ä–∑–∏–Ω–∞ –æ—á–∏—â–µ–Ω–∞', '');
  }

  function openCart(){
    renderCartContent();
    document.getElementById('shCart').classList.add('on');
    if(state.cart.length && state.cartExpireAt) _startTimer();
  }
  function closeCart(){
    document.getElementById('shCart').classList.remove('on');
    _stopTimer();
  }

  function removeFromCart(ttId){
    state.cart = state.cart.filter(i => i.tt_id !== ttId);
    if(!state.cart.length){ state.cartExpireAt = 0; localStorage.removeItem('tb_cart_expire'); }
    saveCart();
    _syncCartToServer();
    renderCartContent(); haptic();
  }

  function renderCartContent(){
    const c = document.getElementById('cartContent');
    const pb = document.getElementById('payBtn');
    const cb = document.getElementById('cancelBtn');
    if(!state.cart.length){
      if(pb){ pb.disabled = true; pb.textContent = '–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞'; }
      if(cb) cb.style.display = 'none';
      c.innerHTML = '<div class="empty"><div class="empty-ico">üõí</div><div>–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div></div>';
      return;
    }
    if(pb){ pb.disabled = false; pb.textContent = 'üí≥ –û–ø–ª–∞—Ç–∏—Ç—å'; }
    if(cb) cb.style.display = '';
    const tot = state.cart.reduce((s,i) => s + i.price * i.qty, 0);
    // –ë–ª–æ–∫ —Ç–∞–π–º–µ—Ä–∞ –≤–≤–µ—Ä—Ö—É
    const timerHtml = state.cartExpireAt
      ? `<div id="cartTimerBlock" class="cart-timer ok"></div>`
      : '';
    c.innerHTML = timerHtml + state.cart.map(it => `
      <div class="ci">
        <div class="ci-title">${it.event_title}</div>
        <div class="ci-sub">üé´ ${it.tt_name} √ó ${it.qty} —à—Ç ¬∑ üìÖ ${it.event_date} ${it.event_time}</div>
        <div class="ci-foot">
          <div class="ci-price">${fmt(it.price * it.qty)}</div>
          <button class="btn bd bsm" onclick="APP.removeFromCart(${it.tt_id})">‚úï –£–±—Ä–∞—Ç—å</button>
        </div>
      </div>`).join('') +
      `<div class="total-row">
        <span class="total-lbl">–ò—Ç–æ–≥–æ</span>
        <span class="total-val">${fmt(tot)}</span>
      </div>`;
    // –°—Ä–∞–∑—É —Ä–µ–Ω–¥–µ—Ä–∏–º –ø–µ—Ä–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞
    if(state.cartExpireAt){
      const left = Math.max(0, Math.floor((state.cartExpireAt - Date.now()) / 1000));
      _renderTimerBlock(left);
    }
  }

  // ‚îÄ‚îÄ –û–ü–õ–ê–¢–ê ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function pay(){
    if(!state.cart.length) return;
    const btn = document.getElementById('payBtn');
    btn.disabled = true; btn.innerHTML = '<div class="ld"></div>';
    haptic();
    try{
      await apiFetch('/api/order', {
        method: 'POST',
        body: JSON.stringify({
          user_id: TG_USER_ID,
          items:   state.cart,
          total:   state.cart.reduce((s,i) => s + i.price * i.qty, 0)
        })
      });
    } catch(e){
      if(TG) try{ TG.sendData(JSON.stringify({action:'order', items:state.cart, user_id:TG_USER_ID})); }catch{}
    }
    state.cart = []; saveCart(); closeCart();
    setTimeout(() => {
      document.getElementById('shSuccess').classList.add('on');
      haptic('success');
    }, 320);
  }

  function closeSuccess(){
    document.getElementById('shSuccess').classList.remove('on');
    _setActiveTab('events');
    goTo('pgBuyer');
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –ö–ê–ë–ò–ù–ï–¢ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  function sellerTab(tab){
    state.currentSelTab = tab;
    const tabs = ['stats','events','add','scan','promo'];
    document.querySelectorAll('.s-tab').forEach((el,i) => el.classList.toggle('on', tabs[i] === tab));
    haptic();
    ({stats:renderStats, events:renderMyEvents, add:renderAddEvent, scan:renderScanner, promo:renderPromos}[tab])?.();
  }

  // ‚îÄ‚îÄ –°–¢–ê–¢–ò–°–¢–ò–ö–ê ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function renderStats(){
    const c = document.getElementById('selContent');
    c.innerHTML = '<div class="empty"><div class="ld"></div></div>';
    let st = {users:0, orders:0, revenue:0, tickets:0};
    try { st = await apiFetch('/api/admin/stats'); } catch {}
    c.innerHTML = `
      <div class="stat-grid">
        ${[['üë•',st.users,'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π'],['üõí',st.orders,'–ó–∞–∫–∞–∑–æ–≤'],['üéü',st.tickets,'–ë–∏–ª–µ—Ç–æ–≤'],['üí∞',fmt(st.revenue),'–í—ã—Ä—É—á–∫–∞']].map((s,i) => `
        <div class="stat-card" style="animation-delay:${i*.07}s">
          <div class="st-ico">${s[0]}</div>
          <div class="st-val">${typeof s[1]==='number' ? s[1].toLocaleString('ru') : s[1]}</div>
          <div class="st-lbl">${s[2]}</div>
        </div>`).join('')}
      </div>
      <button class="btn bp" onclick="APP.sellerTab('events')" style="margin-bottom:16px">üìÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è–º–∏</button>`;
  }

  // ‚îÄ‚îÄ –ú–û–ò –°–û–ë–´–¢–ò–Ø ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function renderMyEvents(){
    const c = document.getElementById('selContent');
    c.innerHTML = '<div class="empty"><div class="ld"></div></div>';
    let evs = [];
    try { evs = await apiFetch('/api/events'); } catch { evs = state.events; }
    if(!evs.length){
      c.innerHTML = '<div class="empty"><div class="empty-ico">üì≠</div><div>–ù–µ—Ç —Å–æ–±—ã—Ç–∏–π</div></div>' +
        '<button class="btn bp" onclick="APP.sellerTab(\'add\')" style="margin:16px 0">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>';
      return;
    }
    c.innerHTML = '<div class="sec">üìÖ –í—Å–µ —Å–æ–±—ã—Ç–∏—è</div>' + evs.map((ev, i) => {
      const sold = ev.ticket_types.reduce((s,t) => s + (t.total - t.available), 0);
      const tot  = ev.ticket_types.reduce((s,t) => s + t.total, 0);
      const pct  = tot > 0 ? Math.round(sold/tot*100) : 0;
      const rev  = ev.ticket_types.reduce((s,t) => s + (t.total-t.available)*t.price, 0);
      return `<div class="ev-mgmt-card" style="animation-delay:${i*.06}s">
        <div class="ev-mgmt-title">${ev.emoji||'üé°'} ${ev.title}</div>
        <div class="ev-mgmt-sub">üìÖ ${ev.date} ¬∑ üìç ${ev.venue}, ${ev.city}</div>
        <div class="prog-bar"><div class="prog-fill" style="width:${pct}%"></div></div>
        <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--muted);margin-bottom:10px">
          <span>–ü—Ä–æ–¥–∞–Ω–æ ${sold}/${tot} (${pct}%)</span>
          <span style="color:var(--green);font-weight:700">${fmt(rev)}</span>
        </div>
        <div class="ev-mgmt-foot">
          <button class="btn bs bsm" onclick="APP.editEvent(${ev.id})" style="flex:1">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å</button>
          <button class="btn bd bsm" onclick="APP.deleteEvent(${ev.id})" style="flex:1">üóë –£–¥–∞–ª–∏—Ç—å</button>
        </div>
      </div>`;
    }).join('') +
    '<button class="btn bp" onclick="APP.sellerTab(\'add\')" style="margin-top:8px;margin-bottom:16px">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ</button>';
  }

  async function deleteEvent(id){
    if(!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–±—ã—Ç–∏–µ?')) return;
    try { await apiFetch(`/api/admin/event/${id}`, {method:'DELETE'}); } catch {}
    state.events = state.events.filter(e => e.id !== id);
    haptic('success'); showToast('üóë –°–æ–±—ã—Ç–∏–µ —É–¥–∞–ª–µ–Ω–æ', 'ok'); renderMyEvents();
  }

  function editEvent(id){
    const ev = state.events.find(e => e.id === id); if(!ev) return;
    sellerTab('add');
    setTimeout(() => _fillEventForm(ev), 150);
  }

  function _fillEventForm(ev){
    const g = id => document.getElementById(id);
    if(g('evId'))       g('evId').value = ev.id;
    if(g('evTitle'))    g('evTitle').value = ev.title;
    if(g('evDesc'))     g('evDesc').value = ev.description || '';
    if(g('evEmoji'))    g('evEmoji').value = ev.emoji || '';
    if(g('evCat'))      g('evCat').value = ev.category;
    if(g('evAge'))      g('evAge').value = ev.age_rating;
    if(g('evVenue'))    g('evVenue').value = ev.venue;
    if(g('evCity'))     g('evCity').value = ev.city;
    if(g('evDate')){
      const p = ev.date.split('.');
      if(p.length === 3) g('evDate').value = `${p[2]}-${p[1]}-${p[0]}`;
    }
    if(g('evTime'))     g('evTime').value = ev.time;
    if(ev.poster_url){
      const prev = document.getElementById('imgPreview');
      if(prev){ prev.src = ev.poster_url; prev.classList.add('on'); }
      const urlIn = document.getElementById('evPosterUrl');
      if(urlIn) urlIn.value = ev.poster_url;
    }
    const tt = ev.ticket_types?.[0];
    if(tt){
      if(g('ttName'))  g('ttName').value = tt.name;
      if(g('ttPrice')) g('ttPrice').value = tt.price;
      if(g('ttSeats')) g('ttSeats').value = tt.total;
    }
    const btn = document.getElementById('submitEvBtn');
    if(btn) btn.textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';
  }

  // ‚îÄ‚îÄ –î–û–ë–ê–í–ò–¢–¨ –°–û–ë–´–¢–ò–ï ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function renderAddEvent(){
    document.getElementById('selContent').innerHTML = `
      <div class="sec">‚ûï –ù–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ</div>
      <input type="hidden" id="evId" value="">
      <div class="fld">
        <label class="fl">üñº –ë–∞–Ω–Ω–µ—Ä –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</label>
        <div class="img-upload" id="imgUploadBox">
          <input type="file" id="imgFile" accept="image/*" onchange="APP.handleImageUpload(this)">
          <div class="img-upload-ico">üì∏</div>
          <div class="img-upload-txt">–ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å —Ñ–æ—Ç–æ<br><span style="font-size:10px;opacity:.6">JPG, PNG –¥–æ 5MB</span></div>
          <img class="img-preview" id="imgPreview" alt="preview">
        </div>
        <div class="img-upload-url">
          <label class="fl">–ò–ª–∏ –≤—Å—Ç–∞–≤—å—Ç–µ URL –∫–∞—Ä—Ç–∏–Ω–∫–∏</label>
          <input class="fi" type="url" id="evPosterUrl" placeholder="https://example.com/image.jpg" oninput="APP.handlePosterUrl(this.value)">
        </div>
      </div>
      <div class="fld"><label class="fl">–ù–∞–∑–≤–∞–Ω–∏–µ</label><input class="fi" id="evTitle" placeholder="Imagine Dragons Live"></div>
      <div class="fld"><label class="fl">–û–ø–∏—Å–∞–Ω–∏–µ</label><textarea class="fi" id="evDesc" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ..."></textarea></div>
      <div class="fld"><label class="fl">–≠–º–æ–¥–∑–∏</label><input class="fi" id="evEmoji" placeholder="üéµ" maxlength="2"></div>
      <div class="frow">
        <div class="fld"><label class="fl">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
          <select class="fi" id="evCat">
            <option value="concert">üéµ –ö–æ–Ω—Ü–µ—Ä—Ç</option><option value="theater">üé≠ –¢–µ–∞—Ç—Ä</option>
            <option value="sport">‚öΩ –°–ø–æ—Ä—Ç</option><option value="exhibition">üñº –í—ã—Å—Ç–∞–≤–∫–∞</option>
            <option value="festival">üé™ –§–µ—Å—Ç–∏–≤–∞–ª—å</option><option value="other">üé° –î—Ä—É–≥–æ–µ</option>
          </select>
        </div>
        <div class="fld"><label class="fl">–í–æ–∑—Ä–∞—Å—Ç</label>
          <select class="fi" id="evAge"><option>0+</option><option>6+</option><option>12+</option><option>16+</option><option>18+</option></select>
        </div>
      </div>
      <div class="fld"><label class="fl">–ü–ª–æ—â–∞–¥–∫–∞</label><input class="fi" id="evVenue" placeholder="Humo Arena"></div>
      <div class="frow">
        <div class="fld"><label class="fl">–ì–æ—Ä–æ–¥</label><input class="fi" id="evCity" placeholder="–¢–æ—à–∫–µ–Ω—Ç"></div>
        <div class="fld"><label class="fl">–î–∞—Ç–∞</label><input class="fi" type="date" id="evDate"></div>
      </div>
      <div class="fld"><label class="fl">–í—Ä–µ–º—è</label><input class="fi" type="time" id="evTime" value="19:00"></div>
      <div class="divider"></div>
      <div class="sec">üé´ –û—Å–Ω–æ–≤–Ω–æ–π —Ç–∏–ø –±–∏–ª–µ—Ç–∞</div>
      <div class="fld"><label class="fl">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–∏–ø–∞</label><input class="fi" id="ttName" placeholder="–°—Ç–∞–Ω–¥–∞—Ä—Ç"></div>
      <div class="frow">
        <div class="fld"><label class="fl">–¶–µ–Ω–∞ (—Å—É–º)</label><input class="fi" type="number" id="ttPrice" placeholder="350000"></div>
        <div class="fld"><label class="fl">–ú–µ—Å—Ç</label><input class="fi" type="number" id="ttSeats" placeholder="100"></div>
      </div>
      <button class="btn bp" id="submitEvBtn" onclick="APP.submitEvent()" style="margin-top:8px">‚úÖ –°–æ–∑–¥–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ</button>
      <div style="height:20px"></div>`;
  }

  function handleImageUpload(input){
    const file = input.files[0]; if(!file) return;
    if(file.size > 5*1024*1024){ showToast('‚ùå –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å 5MB)','err'); return; }
    const reader = new FileReader();
    reader.onload = e => {
      const prev = document.getElementById('imgPreview');
      if(prev){ prev.src = e.target.result; prev.classList.add('on'); }
      const urlField = document.getElementById('evPosterUrl');
      if(urlField) urlField.dataset.base64 = e.target.result;
      showToast('‚úÖ –§–æ—Ç–æ –≤—ã–±—Ä–∞–Ω–æ', 'ok');
    };
    reader.readAsDataURL(file);
  }

  function handlePosterUrl(url){
    if(!url) return;
    const prev = document.getElementById('imgPreview');
    if(prev){ prev.src = url; prev.classList.add('on'); }
  }

  async function submitEvent(){
    const g = id => document.getElementById(id)?.value?.trim() || '';
    const evId    = g('evId');
    const title   = g('evTitle'), venue = g('evVenue'), city = g('evCity');
    const dateVal = g('evDate'), ttName = g('ttName');
    const ttPrice = parseFloat(g('ttPrice')), ttSeats = parseInt(g('ttSeats'));
    if(!title||!venue||!city||!dateVal||!ttName||!ttPrice||!ttSeats){
      showToast('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è','err'); return;
    }
    const dp = dateVal.split('-');
    const dateFormatted = dp.length===3 ? `${dp[2]}.${dp[1]}.${dp[0]}` : dateVal;
    const urlField = document.getElementById('evPosterUrl');
    let posterUrl = urlField?.value?.trim() || '';
    if(urlField?.dataset?.base64) posterUrl = urlField.dataset.base64;
    const payload = {
      title, venue, city,
      description: g('evDesc'),
      category:    document.getElementById('evCat')?.value || 'other',
      age_rating:  document.getElementById('evAge')?.value || '0+',
      date:        dateFormatted,
      time:        g('evTime') || '19:00',
      emoji:       g('evEmoji') || 'üé°',
      poster_url:  posterUrl,
      ticket_types:[{name:ttName, price:ttPrice, total:ttSeats, available:ttSeats}],
    };
    const btn = document.getElementById('submitEvBtn');
    btn.disabled = true; btn.innerHTML = '<div class="ld"></div>';
    try {
      if(evId) await apiFetch(`/api/admin/event/${evId}`, {method:'PUT', body:JSON.stringify(payload)});
      else     await apiFetch('/api/admin/event', {method:'POST', body:JSON.stringify(payload)});
    } catch {
      const newEv = {...payload, id:Date.now(), ticket_types:[{id:Date.now(), name:ttName, price:ttPrice, total:ttSeats, available:ttSeats}]};
      state.events.unshift(newEv);
    }
    haptic('success');
    showToast(evId ? 'üíæ –°–æ–±—ã—Ç–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!' : '‚úÖ –°–æ–±—ã—Ç–∏–µ —Å–æ–∑–¥–∞–Ω–æ!', 'ok');
    renderAddEvent();
    setTimeout(() => loadEvents(), 500);
  }

  // ‚îÄ‚îÄ –°–ö–ê–ù–ï–† ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function renderScanner(){
    document.getElementById('selContent').innerHTML = `
      <div class="sec">üì∑ –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∏–ª–µ—Ç–∞</div>
      <div class="scan-box" id="scanBox">
        <div style="font-size:50px;margin-bottom:10px">üì∑</div>
        <div style="font-weight:700;margin-bottom:5px">–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –±–∏–ª–µ—Ç–∞</div>
        <div style="font-size:11px;color:var(--muted)">UUID –∏–∑ QR-–∫–æ–¥–∞ –±–∏–ª–µ—Ç–∞</div>
      </div>
      <div id="scanResult"></div>
      <div class="fld">
        <label class="fl">UUID –∫–æ–¥ –±–∏–ª–µ—Ç–∞</label>
        <input class="fi" id="qrInput" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
          autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
      </div>
      <button class="btn bp" id="scanBtn" onclick="APP.validateTicket()">üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
      <div style="height:20px"></div>`;
  }

  async function validateTicket(){
    const code = document.getElementById('qrInput')?.value?.trim();
    if(!code){ showToast('‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –±–∏–ª–µ—Ç–∞','err'); return; }
    const btn = document.getElementById('scanBtn');
    btn.disabled = true; btn.innerHTML = '<div class="ld"></div>';
    let result = null;
    try { result = await apiFetch('/api/admin/validate', {method:'POST', body:JSON.stringify({qr_code:code})}); }
    catch(e){ console.error('Validate error:', e); }
    btn.disabled = false; btn.textContent = 'üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å';
    const el = document.getElementById('scanResult');
    if(!result){
      el.innerHTML = '<div class="scan-res bad"><div style="font-weight:700">‚ö†Ô∏è –û–®–ò–ë–ö–ê –°–û–ï–î–ò–ù–ï–ù–ò–Ø</div><div style="font-size:11px;color:var(--muted);margin-top:4px">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É</div></div>';
      showToast('‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è','err');
    } else if(result.status==='valid'){
      haptic('success');
      el.innerHTML = `<div class="scan-res ok"><div style="font-weight:700;margin-bottom:7px">‚úÖ –ë–ò–õ–ï–¢ –î–ï–ô–°–¢–í–ò–¢–ï–õ–ï–ù</div><div style="font-size:12px;color:var(--muted)">üé≠ ${result.event}</div><div style="font-size:12px;color:var(--muted)">üé´ ${result.ticket_type}</div><div style="font-size:12px;color:var(--muted)">üìÖ ${result.date} ¬∑ üìç ${result.venue}</div></div>`;
      showToast('‚úÖ –ë–∏–ª–µ—Ç –ø—Ä–∏–Ω—è—Ç!','ok');
    } else if(result.status==='used'){
      haptic('error');
      el.innerHTML = `<div class="scan-res used"><div style="font-weight:700">‚õî –£–ñ–ï –ò–°–ü–û–õ–¨–ó–û–í–ê–ù</div><div style="font-size:11px;color:var(--muted);margin-top:4px">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω: ${result.used_at||'‚Äî'}</div></div>`;
      showToast('‚õî –ë–∏–ª–µ—Ç —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω','err');
    } else {
      haptic('error');
      el.innerHTML = '<div class="scan-res bad"><div style="font-weight:700">‚ùå –ë–ò–õ–ï–¢ –ù–ï –ù–ê–ô–î–ï–ù</div></div>';
      showToast('‚ùå –ù–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π –±–∏–ª–µ—Ç','err');
    }
    document.getElementById('qrInput').value = '';
  }

  // ‚îÄ‚îÄ –ü–†–û–ú–û–ö–û–î–´ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function renderPromos(){
    const c = document.getElementById('selContent');
    c.innerHTML = '<div class="empty"><div class="ld"></div></div>';
    let promos = [];
    try { promos = await apiFetch('/api/admin/promos'); } catch {}
    c.innerHTML = `
      <div class="sec">üè∑ –ü—Ä–æ–º–æ–∫–æ–¥—ã (${promos.length})</div>
      ${promos.length ? promos.map((p,i) => `
        <div class="promo-card" style="animation-delay:${i*.07}s">
          <div style="flex:1">
            <div class="pc">${p.code} ${p.active
              ? '<span style="font-size:9px;color:var(--green)">‚óè</span>'
              : '<span style="font-size:9px;color:var(--muted)">‚óè</span>'}</div>
            <div class="pi">${p.type==='percent' ? `‚àí${p.value}%` : `‚àí${fmt(p.value)}`} ¬∑ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω ${p.used}/${p.max} —Ä–∞–∑</div>
            <div class="prog-bar" style="width:80px">
              <div class="prog-fill" style="width:${Math.min(100,Math.round(p.used/p.max*100))}%"></div>
            </div>
          </div>
          <button class="btn bd bsm" onclick="APP.deletePromo(${p.id})">‚úï</button>
        </div>`).join('')
      : '<div style="font-size:12px;color:var(--muted);margin-bottom:12px;text-align:center">–ù–µ—Ç –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤</div>'}
      <div class="divider"></div>
      <div class="sec">‚ûï –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥</div>
      <div class="fld"><label class="fl">–ö–æ–¥</label>
        <input class="fi" id="pcCode" placeholder="SUMMER25" oninput="this.value=this.value.toUpperCase()">
      </div>
      <div class="frow">
        <div class="fld"><label class="fl">–¢–∏–ø</label>
          <select class="fi" id="pcType"><option value="percent">% –ü—Ä–æ—Ü–µ–Ω—Ç</option><option value="fixed">—Å—É–º –°—É–º–º–∞</option></select>
        </div>
        <div class="fld"><label class="fl">–†–∞–∑–º–µ—Ä</label><input class="fi" type="number" id="pcVal" placeholder="25"></div>
      </div>
      <div class="fld"><label class="fl">–ú–∞–∫—Å. –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π</label><input class="fi" type="number" id="pcMax" placeholder="100"></div>
      <button class="btn bp" onclick="APP.createPromo()" style="margin-top:4px">‚úÖ –°–æ–∑–¥–∞—Ç—å</button>
      <div style="height:20px"></div>`;
  }

  async function deletePromo(id){
    try { await apiFetch(`/api/admin/promo/${id}`, {method:'DELETE'}); } catch {}
    haptic('success'); showToast('üóë –ü—Ä–æ–º–æ–∫–æ–¥ —É–¥–∞–ª—ë–Ω','ok'); renderPromos();
  }

  async function createPromo(){
    const code = document.getElementById('pcCode')?.value?.trim().toUpperCase();
    const type = document.getElementById('pcType')?.value;
    const val  = parseFloat(document.getElementById('pcVal')?.value);
    const max  = parseInt(document.getElementById('pcMax')?.value);
    if(!code||!val||!max){ showToast('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è','err'); return; }
    try {
      await apiFetch('/api/admin/promo', {method:'POST', body:JSON.stringify({code,type,value:val,max_uses:max})});
    } catch { showToast('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è','err'); return; }
    haptic('success'); showToast(`‚úÖ –ü—Ä–æ–º–æ–∫–æ–¥ ${code} —Å–æ–∑–¥–∞–Ω!`,'ok'); renderPromos();
  }

  // ‚îÄ‚îÄ RIPPLE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.addEventListener('click', e => {
    const t = e.target.closest('.btn,.rc,.ev-card,.tt-card,.tab-item');
    if(!t) return;
    const el = document.createElement('span');
    el.className = 'rpl-el';
    const rc = t.getBoundingClientRect(), sz = Math.max(rc.width, rc.height);
    el.style.cssText = `width:${sz}px;height:${sz}px;left:${e.clientX-rc.left-sz/2}px;top:${e.clientY-rc.top-sz/2}px`;
    t.appendChild(el);
    setTimeout(() => el.remove(), 600);
  });

  // ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function init(){
    _initEvents();
    const saved = localStorage.getItem('tb_role');
    if(saved){
      state.role = saved;
      _showTabbar();
      if(saved === 'buyer'){
        _setActiveTab('events');
        loadEvents();
        goTo('pgBuyer');
      } else {
        _setActiveTab('cabinet');
        goTo('pgSeller');
        sellerTab('stats');
      }
    } else {
      goTo('pgOnboard');
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É —Å —Å–µ—Ä–≤–µ—Ä–∞ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞–¥ localStorage)
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º localStorage —Å—Ä–∞–∑—É –ø–æ–∫–∞ –∂–¥—ë–º —Å–µ—Ä–≤–µ—Ä
    updateCartUI();
    const loaded = await _loadCartFromServer();
    if(loaded){
      updateCartUI();
      showToast('üõí –ö–æ—Ä–∑–∏–Ω–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞', 'ok');
    }
  }

  return {
    chooseRole, switchRole, goTo, tabNav,
    filterEvents, setFilter,
    openEvent, selectTicket, changeQty, addToCart,
    openCart, closeCart, removeFromCart, cancelCart, pay, closeSuccess,
    sellerTab, renderStats, renderMyEvents, renderAddEvent, submitEvent,
    editEvent, deleteEvent,
    handleImageUpload, handlePosterUrl,
    renderScanner, validateTicket,
    renderPromos, createPromo, deletePromo,
    init,
  };
})();

// ‚îÄ‚îÄ –î–ï–ú–û –î–ê–ù–ù–´–ï ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const DEMO_EVENTS = [
  {id:1,title:"Imagine Dragons Live",category:"concert",emoji:"üéµ",
   venue:"–ú–∏–ª–ª–∏–π –±–æ“ì –∞–º—Ñ–∏—Ç–µ–∞—Ç—Ä–∏",city:"–¢–æ—à–∫–µ–Ω—Ç",date:"15.06.2025",time:"19:00",age_rating:"12+",
   description:"–ì—Ä–∞–Ω–¥–∏–æ–∑–Ω–æ–µ —à–æ—É –º–∏—Ä–æ–≤–æ–≥–æ —É—Ä–æ–≤–Ω—è. –õ–∞–∑–µ—Ä—ã, –∫–æ–Ω—Ñ–µ—Ç—Ç–∏ –∏ —Ö–∏—Ç—ã –∏–∑ –≤—Å–µ—Ö –∞–ª—å–±–æ–º–æ–≤. –ñ–∏–≤–æ–π –∑–≤—É–∫, 3 —á–∞—Å–∞ –Ω–µ–∑–∞–±—ã–≤–∞–µ–º–æ–π –º—É–∑—ã–∫–∏!",
   ticket_types:[
     {id:1,name:"–°—Ç–∞–Ω–¥–∞—Ä—Ç",price:350000,available:120,total:200},
     {id:2,name:"VIP",price:850000,available:8,total:30},
     {id:3,name:"–°—Ç—É–¥–µ–Ω—Ç",price:220000,available:40,total:50}]},
  {id:2,title:"–ú—É—Å–∏“õ–∞–ª–∏ –ö–µ—á–∞",category:"theater",emoji:"üé≠",
   venue:"–ù–∞–≤–æ–∏–π —Ç–µ–∞—Ç—Ä–∏",city:"–¢–æ—à–∫–µ–Ω—Ç",date:"22.06.2025",time:"18:30",age_rating:"0+",
   description:"–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π —Å–ø–µ–∫—Ç–∞–∫–ª—å –≤ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–∏ –≤–µ–¥—É—â–µ–π —Ç—Ä—É–ø–ø—ã –£–∑–±–µ–∫–∏—Å—Ç–∞–Ω–∞. –í–µ—á–µ—Ä –≤—ã—Å–æ–∫–æ–≥–æ –∏—Å–∫—É—Å—Å—Ç–≤–∞ –∏ –ø—Ä–µ–∫—Ä–∞—Å–Ω–æ–π –º—É–∑—ã–∫–∏.",
   ticket_types:[
     {id:4,name:"–ü–∞—Ä—Ç–µ—Ä",price:500000,available:80,total:150},
     {id:5,name:"–ë–∞–ª–∫–æ–Ω",price:250000,available:200,total:300},
     {id:6,name:"–õ–æ–∂–∞ VIP",price:1200000,available:4,total:8}]},
  {id:3,title:"UFC Fight Night Tashkent",category:"sport",emoji:"ü•ä",
   venue:"Humo Arena",city:"–¢–æ—à–∫–µ–Ω—Ç",date:"30.06.2025",time:"20:00",age_rating:"16+",
   description:"–í–µ—á–µ—Ä —Å–º–µ—à–∞–Ω–Ω—ã—Ö –µ–¥–∏–Ω–æ–±–æ—Ä—Å—Ç–≤. –¢–æ–ø–æ–≤—ã–µ –±–æ–π—Ü—ã –≤ –ø—Ä—è–º–æ–º —ç—Ñ–∏—Ä–µ! –ù–µ–∑–∞–±—ã–≤–∞–µ–º–æ–µ –∑—Ä–µ–ª–∏—â–µ –¥–ª—è –≤—Å–µ–π —Å–µ–º—å–∏.",
   ticket_types:[
     {id:7,name:"–¢—Ä–∏–±—É–Ω–∞",price:200000,available:500,total:1000},
     {id:8,name:"–†–∏–Ω–≥-—Å–∞–π–¥",price:1500000,available:3,total:20}]},
  {id:4,title:"Tashkent Music Fest 2025",category:"festival",emoji:"üé™",
   venue:"–ë–æ—Ç–∞–Ω–∏–∫–∞ –±–æ“ì–∏",city:"–¢–æ—à–∫–µ–Ω—Ç",date:"12.07.2025",time:"12:00",age_rating:"0+",
   description:"–ì–ª–∞–≤–Ω—ã–π –ª–µ—Ç–Ω–∏–π —Ñ–µ—Å—Ç–∏–≤–∞–ª—å —Å 30+ –∞—Ä—Ç–∏—Å—Ç–∞–º–∏ –Ω–∞ 5 —Å—Ü–µ–Ω–∞—Ö. –ï–¥–∞, —Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏—è, –∂–∏–≤–∞—è –º—É–∑—ã–∫–∞ —Ü–µ–ª—ã–π –¥–µ–Ω—å!",
   ticket_types:[
     {id:9,name:"–û–¥–Ω–æ–¥–Ω–µ–≤–Ω—ã–π",price:450000,available:1000,total:5000},
     {id:10,name:"VIP-–∑–æ–Ω–∞",price:1200000,available:50,total:100}]},
  {id:5,title:"–é–∑–±–µ–∫ –†–∞—Å—Å–æ–º–ª–∞—Ä–∏",category:"exhibition",emoji:"üñº",
   venue:"–°–∞–Ω—ä–∞—Ç –º—É–∑–µ–π–∏",city:"–¢–æ—à–∫–µ–Ω—Ç",date:"01.06.2025",time:"10:00",age_rating:"0+",
   description:"–í—ã—Å—Ç–∞–≤–∫–∞ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —É–∑–±–µ–∫—Å–∫–æ–≥–æ –∏—Å–∫—É—Å—Å—Ç–≤–∞. –ñ–∏–≤–æ–ø–∏—Å—å, —Å–∫—É–ª—å–ø—Ç—É—Ä–∞, –∏–Ω—Å—Ç–∞–ª–ª—è—Ü–∏–∏ –æ—Ç –≤–µ–¥—É—â–∏—Ö –º–∞—Å—Ç–µ—Ä–æ–≤ —Å—Ç—Ä–∞–Ω—ã.",
   ticket_types:[
     {id:11,name:"–í–∑—Ä–æ—Å–ª—ã–π",price:80000,available:300,total:500},
     {id:12,name:"–õ—å–≥–æ—Ç–Ω—ã–π",price:40000,available:100,total:200}]},
];

APP.init();
</script>
</body>
</html>
